apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: {{ include "k8s-ndots-admission-controller.fullname" . }}
  labels:
    {{- include "k8s-ndots-admission-controller.labels" . | nindent 4 }}
  annotations:
    {{- with .Values.commonAnnotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- if .Values.tls.useCertManager }}
    cert-manager.io/inject-ca-from: {{ .Release.Namespace }}/{{ include "k8s-ndots-admission-controller.fullname" . }}
    {{- end }}
webhooks:
  - name: ndots.admission.k8s.io
    admissionReviewVersions:
      - v1
    sideEffects: None
    failurePolicy: {{ .Values.webhook.failurePolicy }}
    reinvocationPolicy: {{ .Values.webhook.reinvocationPolicy }}
    timeoutSeconds: {{ .Values.webhook.timeoutSeconds }}
    clientConfig:
      service:
        name: {{ include "k8s-ndots-admission-controller.fullname" . }}
        namespace: {{ .Release.Namespace }}
        path: /mutate
        port: {{ .Values.service.port }}
      {{- if not .Values.tls.useCertManager }}
      caBundle: ""  # Must be populated manually or via script
      {{- end }}
    rules:
      - apiGroups:
          - ""
        apiVersions:
          - v1
        operations:
          - CREATE
        resources:
          - pods
        scope: Namespaced
    {{- if or .Values.namespace.exclude .Values.namespace.include }}
    namespaceSelector:
      matchExpressions:
        {{- if .Values.namespace.exclude }}
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values:
            {{- toYaml .Values.namespace.exclude | nindent 12 }}
        {{- end }}
        {{- if .Values.namespace.include }}
        - key: kubernetes.io/metadata.name
          operator: In
          values:
            {{- toYaml .Values.namespace.include | nindent 12 }}
        {{- end }}
    {{- end }}
